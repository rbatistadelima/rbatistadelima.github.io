<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Legendas ao Vivo</title>
<style>
  body {
    margin: 0;
    background: #00ff00; /* verde chroma */
    color: white;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    overflow: hidden;
    font-family: Arial, sans-serif;
  }

  #micLevel {
    width: 300px;
    height: 10px;
    background: linear-gradient(to right, red, yellow, lime);
    transform: scaleX(-1); /* inverter ordem das cores */
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 10px;
  }

  #micFill {
    height: 100%;
    width: 0%;
    background: white;
    border-radius: 10px;
    transition: width 0.1s linear;
  }

  #controls {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    background: rgba(0,0,0,0.6);
    padding: 10px;
    border-radius: 10px;
    position: absolute;
    top: 10px;
  }

  select, input[type="checkbox"], input[type="range"], button {
    font-size: 1em;
    padding: 5px;
    border-radius: 5px;
  }

  button {
    cursor: pointer;
  }

  #captions {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    line-height: 1.1em;
  }

  .caption {
    background: rgba(0,0,0,0.7);
    padding: 10px 20px;
    border-radius: 20px;
    display: inline-block;
    max-width: 80vw;
    box-shadow: 0 0 10px rgba(0,0,0,0.6);
    margin: 5px 0;
    word-break: break-word;
  }

  /* Caixa JRPG */
  #jrpgBox {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(20, 20, 20, 0.9);
    color: white;
    text-align: left;
    padding: 20px 30px;
    border-radius: 20px;
    width: 80%;
    max-width: 800px;
    box-shadow: 0 0 20px rgba(0,0,0,0.8);
  }
</style>
</head>
<body>
  <div id="micLevel"><div id="micFill"></div></div>

  <div id="controls">
    <select id="micSelect"></select>
    <button id="toggle">ðŸŽ§ Clique para Iniciar</button>
    <label>MaiÃºsculas <input type="checkbox" id="upper"></label>
    <label>Modo JRPG <input type="checkbox" id="jrpg"></label>
    <label>Fonte:
      <select id="fontSelect">
        <option style="font-family: Arial;" value="Arial">Arial</option>
        <option style="font-family: Verdana;" value="Verdana">Verdana</option>
        <option style="font-family: Tahoma;" value="Tahoma">Tahoma</option>
        <option style="font-family: Georgia;" value="Georgia">Georgia</option>
        <option style="font-family: Trebuchet MS;" value="Trebuchet MS">Trebuchet</option>
        <option style="font-family: Comic Sans MS;" value="Comic Sans MS">Comic Sans</option>
        <option style="font-family: Impact;" value="Impact">Impact</option>
        <option style="font-family: 'Press Start 2P';" value="'Press Start 2P'">Pixel 2P</option>
        <option style="font-family: 'VT323';" value="'VT323'">VT323</option>
        <option style="font-family: 'Silkscreen';" value="'Silkscreen'">Silkscreen</option>
      </select>
    </label>
    <label>Borda <input type="range" id="borderRange" min="0" max="3" step="1" value="2"></label>
  </div>

  <div id="captions"></div>
  <div id="jrpgBox"></div>

<!-- fontes pixel extras -->
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&family=Silkscreen&display=swap" rel="stylesheet">

<script>
let recognition, listening = false, lastText = "", timer;
const captions = document.getElementById("captions");
const jrpgBox = document.getElementById("jrpgBox");
const micSelect = document.getElementById("micSelect");
const toggle = document.getElementById("toggle");
const micFill = document.getElementById("micFill");
const upper = document.getElementById("upper");
const jrpg = document.getElementById("jrpg");
const fontSelect = document.getElementById("fontSelect");
const borderRange = document.getElementById("borderRange");

async function loadMics() {
  const devices = await navigator.mediaDevices.enumerateDevices();
  micSelect.innerHTML = "";
  devices.filter(d => d.kind === "audioinput").forEach(d => {
    const opt = document.createElement("option");
    const [first, ...rest] = d.label.split(" ");
    opt.value = d.deviceId;
    opt.textContent = `ðŸŽ™ï¸ ${first ? first : 'Microfone'} ${rest.join(" ")}`;
    micSelect.appendChild(opt);
  });
}

function showCaption(text) {
  clearTimeout(timer);
  if (upper.checked) text = text.toUpperCase();

  const caption = document.createElement("div");
  caption.className = "caption";
  caption.textContent = text;
  caption.style.fontFamily = fontSelect.value;
  caption.style.webkitTextStroke = borderRange.value + "px black";

  captions.innerHTML = "";
  captions.appendChild(caption);

  if (jrpg.checked) {
    jrpgBox.style.display = "block";
    jrpgBox.style.fontFamily = fontSelect.value;
    jrpgBox.style.webkitTextStroke = borderRange.value + "px black";
    jrpgBox.textContent = text;
  } else {
    jrpgBox.style.display = "none";
  }

  timer = setTimeout(() => {
    if (!jrpg.checked) captions.innerHTML = "";
  }, 3000);
}

function startListening() {
  window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.lang = "pt-BR";
  recognition.interimResults = true;
  recognition.continuous = true;

  recognition.onresult = (e) => {
    let transcript = Array.from(e.results)
      .map(r => r[0].transcript)
      .join(" ");
    if (transcript.trim() && transcript !== lastText) {
      lastText = transcript.trim();
      showCaption(transcript);
    }
  };

  recognition.onerror = (e) => {
    if (e.error !== "no-speech") console.error(e);
  };

  recognition.start();
  toggle.textContent = "â¸ï¸ Parado";
  listening = true;
}

function stopListening() {
  if (recognition) recognition.stop();
  toggle.textContent = "ðŸŽ§ Clique para Iniciar";
  listening = false;
}

toggle.onclick = () => {
  if (!listening) startListening(); else stopListening();
};

loadMics();

// medidor de som
navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
  const ctx = new AudioContext();
  const src = ctx.createMediaStreamSource(stream);
  const analyser = ctx.createAnalyser();
  src.connect(analyser);
  const data = new Uint8Array(analyser.frequencyBinCount);
  function loop() {
    analyser.getByteFrequencyData(data);
    let volume = data.reduce((a,b)=>a+b)/data.length;
    micFill.style.width = Math.min(volume/2,100) + "%";
    requestAnimationFrame(loop);
  }
  loop();
});
</script>
</body>
</html>
