<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Legendas ao Vivo</title>
<style>
  body {
    margin: 0;
    background: #00ff00; /* fundo verde chroma padrão */
    color: white;
    font-family: Arial, sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100vh;
    overflow: hidden;
  }

  #controls {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    background: rgba(0,0,0,0.5);
    padding: 10px;
    border-radius: 10px;
    margin-top: 10px;
  }

  #micLevel {
    width: 300px;
    height: 10px;
    background: linear-gradient(to right, red, yellow, lime);
    transform: scaleX(-1); /* inverter cores */
    border-radius: 10px;
    margin-bottom: 10px;
    overflow: hidden;
  }

  #micFill {
    height: 100%;
    width: 0%;
    background: white;
    border-radius: 10px;
    transition: width 0.1s linear;
  }

  #captions {
    display: flex;
    flex-direction: column-reverse;
    align-items: center;
    justify-content: flex-end;
    height: 70vh;
    width: 90%;
    text-align: center;
    font-size: 2em;
    line-height: 1.1em;
    font-weight: bold;
  }

  .caption {
    background: rgba(0,0,0,0.7);
    padding: 10px 20px;
    border-radius: 20px;
    margin: 5px 0;
    display: inline-block;
    max-width: 80%;
    box-shadow: 0 0 10px rgba(0,0,0,0.6);
  }

  /* Caixa JRPG */
  #jrpgBox {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(20, 20, 20, 0.9);
    color: white;
    font-size: 1.8em;
    line-height: 1.3em;
    text-align: left;
    padding: 20px 30px;
    border-radius: 20px;
    width: 80%;
    max-width: 800px;
    min-height: 150px;
    box-shadow: 0 0 20px rgba(0,0,0,0.8);
  }

  select, input[type="checkbox"], input[type="range"], button {
    font-size: 1em;
    padding: 5px;
    border-radius: 5px;
  }

  button {
    cursor: pointer;
  }
</style>
</head>
<body>
  <div id="micLevel"><div id="micFill"></div></div>

  <div id="controls">
    <select id="micSelect"></select>
    <button id="toggle">🎧 Clique para Iniciar</button>
    <label>Maiúsculas <input type="checkbox" id="upper"></label>
    <label>Modo JRPG <input type="checkbox" id="jrpg"></label>
  </div>

  <div id="captions"></div>
  <div id="jrpgBox"></div>

<script>
let recognition, listening = false, lastText = "", timer;
const captions = document.getElementById("captions");
const jrpgBox = document.getElementById("jrpgBox");
const micSelect = document.getElementById("micSelect");
const toggle = document.getElementById("toggle");
const micFill = document.getElementById("micFill");
const upper = document.getElementById("upper");
const jrpg = document.getElementById("jrpg");

async function loadMics() {
  const devices = await navigator.mediaDevices.enumerateDevices();
  micSelect.innerHTML = "";
  devices.filter(d => d.kind === "audioinput").forEach(d => {
    const opt = document.createElement("option");
    const [first, ...rest] = d.label.split(" ");
    opt.value = d.deviceId;
    opt.textContent = `🎙️ ${first ? first : 'Microfone'} ${rest.join(" ")}`;
    micSelect.appendChild(opt);
  });
}

function showCaption(text) {
  clearTimeout(timer);
  if (upper.checked) text = text.toUpperCase();
  const caption = document.createElement("div");
  caption.className = "caption";
  caption.textContent = text;
  captions.prepend(caption);

  // Atualiza modo JRPG
  if (jrpg.checked) {
    jrpgBox.style.display = "block";
    jrpgBox.textContent = text;
  } else {
    jrpgBox.style.display = "none";
  }

  timer = setTimeout(() => {
    if (!jrpg.checked) caption.remove();
  }, 3000);
}

function startListening() {
  window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.lang = "pt-BR";
  recognition.interimResults = true;
  recognition.continuous = true;

  recognition.onresult = (e) => {
    let transcript = Array.from(e.results).map(r => r[0].transcript).join(" ");
    if (transcript.trim() && transcript !== lastText) {
      lastText = transcript.trim();
      showCaption(transcript);
    }
  };

  recognition.onerror = (e) => {
    if (e.error !== "no-speech") console.error(e);
  };

  recognition.start();
  toggle.textContent = "⏸️ Parado";
  listening = true;
}

function stopListening() {
  if (recognition) recognition.stop();
  toggle.textContent = "🎧 Clique para Iniciar";
  listening = false;
}

toggle.onclick = () => {
  if (!listening) startListening(); else stopListening();
};

loadMics();

// Simula barra de som
navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
  const ctx = new AudioContext();
  const src = ctx.createMediaStreamSource(stream);
  const analyser = ctx.createAnalyser();
  src.connect(analyser);
  const data = new Uint8Array(analyser.frequencyBinCount);
  function loop() {
    analyser.getByteFrequencyData(data);
    let volume = data.reduce((a,b)=>a+b)/data.length;
    micFill.style.width = Math.min(volume/2,100) + "%";
    requestAnimationFrame(loop);
  }
  loop();
});
</script>
</body>
</html>
