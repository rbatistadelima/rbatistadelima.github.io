<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>PC-98 Image Studio</title>
<style>
  html,body{margin:0;padding:0;overflow:hidden;background:#111;color:#eee;
    font-family:sans-serif;height:100vh;width:100vw;}
  #app{display:grid;grid-template-columns:300px 1fr;height:100vh;}
  aside{background:#222;padding:12px;display:flex;flex-direction:column;gap:8px;
    overflow:hidden;box-shadow:2px 0 6px #000;}
  label{font-size:13px;margin-top:6px;}
  input[type=range]{width:100%;}
  canvas{background:#000;display:block;margin:auto;max-width:100%;image-rendering:pixelated;}
  button{background:#333;border:none;color:#eee;padding:6px 8px;cursor:pointer;
    border-radius:4px;margin-top:4px;}
  button:hover{background:#444;}
  .row{display:flex;gap:4px;}
</style>
</head>
<body>
<div id="app">
  <aside>
    <h3>PC-98 Studio</h3>
    <label>Upload Image</label>
    <input type="file" id="fileInput" accept="image/*"/>

    <label>Brush Size</label>
    <input type="range" id="brushSize" min="1" max="64" value="16"/>
    <label>Brush Opacity</label>
    <input type="range" id="brushOpacity" min="0" max="1" step="0.01" value="0.5"/>

    <div class="row">
      <button id="modeLight">Lighten</button>
      <button id="modeDark">Darken</button>
    </div>
    <div class="row">
      <button id="undoBtn">Undo</button>
      <button id="redoBtn">Redo</button>
    </div>
    <button id="clearMask">Clear Masks</button>

    <hr>
    <label>Brightness</label>
    <input type="range" id="brightness" min="-1" max="1" step="0.01" value="0"/>
    <label>Contrast</label>
    <input type="range" id="contrast" min="-1" max="1" step="0.01" value="0"/>
    <label>Saturation</label>
    <input type="range" id="saturation" min="0" max="2" step="0.01" value="1"/>

    <button id="downloadBtn">Download</button>
    <button id="resetBtn">Reset</button>
  </aside>
  <canvas id="canvas" width="640" height="400"></canvas>
</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let img = new Image();
let baseLayer, darkMask, lightMask;
let painting=false, paintMode='light', brushSize=16, brushOpacity=0.5;
let undoStack=[], redoStack=[];

function resetMasks(){
  darkMask = document.createElement('canvas');
  lightMask = document.createElement('canvas');
  [darkMask,lightMask].forEach(c=>{
    c.width=canvas.width;c.height=canvas.height;
    c.getContext('2d').clearRect(0,0,c.width,c.height);
  });
}
resetMasks();

function pushUndo(){
  if(undoStack.length>20) undoStack.shift();
  undoStack.push({
    dark: darkMask.getContext('2d').getImageData(0,0,canvas.width,canvas.height),
    light: lightMask.getContext('2d').getImageData(0,0,canvas.width,canvas.height)
  });
  redoStack=[];
}

function restoreState(state){
  darkMask.getContext('2d').putImageData(state.dark,0,0);
  lightMask.getContext('2d').putImageData(state.light,0,0);
  render();
}

document.getElementById('undoBtn').onclick=()=>{
  if(undoStack.length){
    redoStack.push({
      dark:darkMask.getContext('2d').getImageData(0,0,canvas.width,canvas.height),
      light:lightMask.getContext('2d').getImageData(0,0,canvas.width,canvas.height)
    });
    restoreState(undoStack.pop());
  }
};
document.getElementById('redoBtn').onclick=()=>{
  if(redoStack.length){
    undoStack.push({
      dark:darkMask.getContext('2d').getImageData(0,0,canvas.width,canvas.height),
      light:lightMask.getContext('2d').getImageData(0,0,canvas.width,canvas.height)
    });
    restoreState(redoStack.pop());
  }
};

function drawBrush(x,y){
  const ctxMask = (paintMode==='light'?lightMask:darkMask).getContext('2d');
  ctxMask.globalAlpha = brushOpacity;
  ctxMask.fillStyle = paintMode==='light' ? 'white' : 'black';
  ctxMask.beginPath();
  ctxMask.arc(x,y,brushSize,0,Math.PI*2);
  ctxMask.fill();
  ctxMask.globalAlpha=1;
}

canvas.addEventListener('mousedown',e=>{
  if(!img.src)return;
  pushUndo();
  painting=true;
  const rect=canvas.getBoundingClientRect();
  drawBrush(e.clientX-rect.left,e.clientY-rect.top);
  render();
});
canvas.addEventListener('mousemove',e=>{
  if(!painting)return;
  const rect=canvas.getBoundingClientRect();
  drawBrush(e.clientX-rect.left,e.clientY-rect.top);
  render();
});
window.addEventListener('mouseup',()=>painting=false);

document.getElementById('brushSize').oninput=e=>brushSize=parseInt(e.target.value);
document.getElementById('brushOpacity').oninput=e=>brushOpacity=parseFloat(e.target.value);
document.getElementById('modeLight').onclick=()=>paintMode='light';
document.getElementById('modeDark').onclick=()=>paintMode='dark';
document.getElementById('clearMask').onclick=()=>{resetMasks();render();};

function render(){
  if(!img.src)return;
  ctx.drawImage(baseLayer,0,0,canvas.width,canvas.height);
  ctx.save();
  // darken mask
  ctx.globalCompositeOperation='multiply';
  ctx.drawImage(darkMask,0,0);
  // lighten mask
  ctx.globalCompositeOperation='screen';
  ctx.drawImage(lightMask,0,0);
  ctx.restore();

  applyPC98Look();
}

function applyPC98Look(){
  const brightness=parseFloat(document.getElementById('brightness').value);
  const contrast=parseFloat(document.getElementById('contrast').value);
  const saturation=parseFloat(document.getElementById('saturation').value);
  const imgData=ctx.getImageData(0,0,canvas.width,canvas.height);
  const d=imgData.data;
  for(let i=0;i<d.length;i+=4){
    let r=d[i],g=d[i+1],b=d[i+2];
    // brightness & contrast
    r=(r/255+brightness)* (1+contrast);
    g=(g/255+brightness)* (1+contrast);
    b=(b/255+brightness)* (1+contrast);
    // saturation
    const avg=(r+g+b)/3;
    r=avg+(r-avg)*saturation;
    g=avg+(g-avg)*saturation;
    b=avg+(b-avg)*saturation;
    // quantize 6-bit (PC-98 style)
    r=Math.round(r*63)/63;
    g=Math.round(g*63)/63;
    b=Math.round(b*63)/63;
    d[i]=Math.min(255,Math.max(0,r*255));
    d[i+1]=Math.min(255,Math.max(0,g*255));
    d[i+2]=Math.min(255,Math.max(0,b*255));
  }
  ctx.putImageData(imgData,0,0);
  // simple CRT scanlines
  const scan=ctx.getImageData(0,0,canvas.width,canvas.height);
  for(let y=0;y<canvas.height;y+=2){
    for(let x=0;x<canvas.width;x++){
      const idx=(y*canvas.width+x)*4;
      scan.data[idx]*=0.75;
      scan.data[idx+1]*=0.75;
      scan.data[idx+2]*=0.75;
    }
  }
  ctx.putImageData(scan,0,0);
}

document.getElementById('fileInput').addEventListener('change',e=>{
  const file=e.target.files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=ev=>{
    img.onload=()=>{
      const scale=Math.min(canvas.width/img.width,canvas.height/img.height);
      baseLayer=document.createElement('canvas');
      baseLayer.width=canvas.width;
      baseLayer.height=canvas.height;
      const bctx=baseLayer.getContext('2d');
      const w=img.width*scale,h=img.height*scale;
      const x=(canvas.width-w)/2,y=(canvas.height-h)/2;
      bctx.drawImage(img,x,y,w,h);
      resetMasks();
      render();
    };
    img.src=ev.target.result;
  };
  reader.readAsDataURL(file);
});

document.getElementById('downloadBtn').onclick=()=>{
  const link=document.createElement('a');
  link.download='pc98-image.png';
  link.href=canvas.toDataURL();
  link.click();
};

document.getElementById('resetBtn').onclick=()=>{
  document.querySelectorAll('input[type=range]').forEach(i=>{
    if(i.id==='saturation')i.value=1;else i.value=0;
  });
  resetMasks();
  render();
};
</script>
</body>
</html>
