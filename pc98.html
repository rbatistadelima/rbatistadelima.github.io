<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PC-98 Pixel Art Converter</title>
<style>
  body {
    margin: 0;
    font-family: sans-serif;
    display: flex;
    height: 100vh;
    overflow: hidden;
  }
  #sidebar {
    width: 300px;
    background: #222;
    color: #fff;
    padding: 10px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  #sidebar label {
    display: block;
    margin-top: 5px;
  }
  #canvas-container {
    flex: 1;
    background: #000;
    position: relative;
    overflow: hidden;
    cursor: grab;
  }
  canvas {
    display: block;
    margin: auto;
    max-width: 100%;
    max-height: 100%;
    image-rendering: pixelated;
  }
  input[type="range"] {
    width: 100%;
  }
  button {
    margin-top: 5px;
    padding: 5px;
    cursor: pointer;
  }
</style>
</head>
<body>

<div id="sidebar">
  <h2>PC-98 Converter</h2>
  
  <label>Brightness: <span id="brightnessVal">0</span></label>
  <input type="range" id="brightness" min="-1" max="1" step="0.01" value="0">
  
  <label>Contrast: <span id="contrastVal">1</span></label>
  <input type="range" id="contrast" min="0" max="2" step="0.01" value="1">
  
  <label>Saturation: <span id="saturationVal">1</span></label>
  <input type="range" id="saturation" min="0" max="2" step="0.01" value="1">
  
  <label>Outline Thickness: <span id="outlineVal">1</span> px</label>
  <input type="range" id="outline" min="1" max="10" step="1" value="1">
  
  <label>Palette:</label>
  <select id="palette">
    <option value="16">16-color</option>
    <option value="256">256-color</option>
    <option value="pc98">PC-98 classic</option>
  </select>
  
  <label>Dithering:</label>
  <select id="dither">
    <option value="none">None</option>
    <option value="bayer">Ordered (Bayer)</option>
    <option value="floyd">Floyd-Steinberg</option>
    <option value="random">Random</option>
  </select>
  
  <label>Dither Intensity: <span id="ditherVal">1</span></label>
  <input type="range" id="ditherIntensity" min="0" max="1" step="0.01" value="1">
  
  <label>Scale:</label>
  <input type="range" id="scale" min="10" max="200" value="100"> <span id="scaleVal">100%</span>
  
  <button id="reset">Reset</button>
  <button id="download">Download Image</button>
</div>

<div id="canvas-container">
  <canvas id="canvas" width="640" height="400"></canvas>
</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let img = new Image();
let scale = 1;
let offsetX = 0, offsetY = 0;
let isDragging = false, dragStart = {x:0, y:0};

const brightness = document.getElementById('brightness');
const contrast = document.getElementById('contrast');
const saturation = document.getElementById('saturation');
const outline = document.getElementById('outline');
const palette = document.getElementById('palette');
const dither = document.getElementById('dither');
const ditherIntensity = document.getElementById('ditherIntensity');
const scaleInput = document.getElementById('scale');

const brightnessVal = document.getElementById('brightnessVal');
const contrastVal = document.getElementById('contrastVal');
const saturationVal = document.getElementById('saturationVal');
const outlineVal = document.getElementById('outlineVal');
const ditherVal = document.getElementById('ditherVal');
const scaleVal = document.getElementById('scaleVal');

function resetControls() {
  brightness.value = 0;
  contrast.value = 1;
  saturation.value = 1;
  outline.value = 1;
  palette.value = '16';
  dither.value = 'none';
  ditherIntensity.value = 1;
  scaleInput.value = 100;
  updateDisplayValues();
  render();
}

function updateDisplayValues() {
  brightnessVal.innerText = brightness.value;
  contrastVal.innerText = contrast.value;
  saturationVal.innerText = saturation.value;
  outlineVal.innerText = outline.value;
  ditherVal.innerText = ditherIntensity.value;
  scaleVal.innerText = scaleInput.value + '%';
}

function applyFilters(imageData) {
  const data = imageData.data;
  const b = parseFloat(brightness.value);
  const c = parseFloat(contrast.value);
  const s = parseFloat(saturation.value);

  for (let i=0; i<data.length; i+=4){
    let r = data[i]/255, g = data[i+1]/255, bl = data[i+2]/255;

    // Saturation
    let avg = 0.2126*r + 0.7152*g + 0.0722*bl;
    r = avg + s*(r - avg);
    g = avg + s*(g - avg);
    bl = avg + s*(bl - avg);

    // Brightness & contrast
    r = ((r + b) - 0.5)*c + 0.5;
    g = ((g + b) - 0.5)*c + 0.5;
    bl = ((bl + b) - 0.5)*c + 0.5;

    data[i] = Math.max(0, Math.min(255, r*255));
    data[i+1] = Math.max(0, Math.min(255, g*255));
    data[i+2] = Math.max(0, Math.min(255, bl*255));
  }
  return imageData;
}

function applyOutline(imageData, thickness=1) {
  const w = canvas.width, h = canvas.height;
  const copy = new Uint8ClampedArray(imageData.data);
  const data = imageData.data;
  
  function get(x,y,c){
    if(x<0||x>=w||y<0||y>=h) return 0;
    return copy[(y*w+x)*4+c];
  }

  for(let y=0;y<h;y++){
    for(let x=0;x<w;x++){
      let idx = (y*w+x)*4;
      let edge = false;
      for(let oy=-thickness; oy<=thickness; oy++){
        for(let ox=-thickness; ox<=thickness; ox++){
          if(ox===0 && oy===0) continue;
          for(let c=0;c<3;c++){
            if(Math.abs(get(x,y,c) - get(x+ox,y+oy,c))>20) edge=true;
          }
        }
      }
      if(edge){
        data[idx]=0; data[idx+1]=0; data[idx+2]=0;
      }
    }
  }
  return imageData;
}

// Simple 16-color palette
function quantizeColors(imageData) {
  const data = imageData.data;
  const palette16 = [
    [0,0,0],[0,0,170],[0,170,0],[0,170,170],
    [170,0,0],[170,0,170],[170,85,0],[170,170,170],
    [85,85,85],[85,85,255],[85,255,85],[85,255,255],
    [255,85,85],[255,85,255],[255,255,85],[255,255,255]
  ];
  for(let i=0;i<data.length;i+=4){
    let r = data[i], g=data[i+1], b=data[i+2];
    let best = 0, dist = 1e9;
    palette16.forEach((c,j)=>{
      let d = (r-c[0])**2 + (g-c[1])**2 + (b-c[2])**2;
      if(d<dist){ dist=d; best=j;}
    });
    data[i]=palette16[best][0];
    data[i+1]=palette16[best][1];
    data[i+2]=palette16[best][2];
  }
  return imageData;
}

function render() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(img, 0,0, canvas.width, canvas.height);
  let imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
  imageData = applyFilters(imageData);
  imageData = quantizeColors(imageData);
  imageData = applyOutline(imageData, parseInt(outline.value));
  ctx.putImageData(imageData,0,0);
}

canvas.addEventListener('wheel', e=>{
  e.preventDefault();
  scale += e.deltaY<0?0.1:-0.1;
  scale = Math.max(0.1, Math.min(5, scale));
  canvas.style.transform = `scale(${scale}) translate(${offsetX}px,${offsetY}px)`;
});

canvas.addEventListener('mousedown', e=>{
  isDragging=true;
  dragStart = {x:e.clientX-offsetX, y:e.clientY-offsetY};
  canvas.style.cursor='grabbing';
});
canvas.addEventListener('mouseup', e=>{
  isDragging=false;
  canvas.style.cursor='grab';
});
canvas.addEventListener('mousemove', e=>{
  if(isDragging){
    offsetX=e.clientX-dragStart.x;
    offsetY=e.clientY-dragStart.y;
    canvas.style.transform = `scale(${scale}) translate(${offsetX}px,${offsetY}px)`;
  }
});

// Drag & drop
document.getElementById('canvas-container').addEventListener('drop', e=>{
  e.preventDefault();
  const file = e.dataTransfer.files[0];
  if(file && file.type.startsWith('image')){
    const reader = new FileReader();
    reader.onload = ev=>{
      img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  }
});
document.getElementById('canvas-container').addEventListener('dragover', e=>e.preventDefault());

// Update controls
[brightness, contrast, saturation, outline, ditherIntensity, scaleInput].forEach(input=>{
  input.addEventListener('input', ()=>{
    updateDisplayValues();
    render();
  });
});
[palette,dither].forEach(sel=>{
  sel.addEventListener('change', render);
});

document.getElementById('reset').addEventListener('click', resetControls);
document.getElementById('download').addEventListener('click', ()=>{
  const link = document.createElement('a');
  link.download = 'pc98_image.png';
  link.href = canvas.toDataURL();
  link.click();
});

// initial
img.onload = render;
resetControls();
</script>

</body>
</html>
