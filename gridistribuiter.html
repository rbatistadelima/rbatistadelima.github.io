<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Distributor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            color: white;
            font-family: Arial, sans-serif;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            user-select: none;
        }
        
        #moodboard {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: grid;
            gap: 1px;
        }
        
        .image-container {
            position: relative;
            overflow: hidden;
            background: #111;
            cursor: grab;
        }
        
        .image-container.dragging {
            opacity: 0.5;
            cursor: grabbing;
            z-index: 100;
        }
        
        .image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            pointer-events: none;
        }
        
        /* Minimal UI */
        #ui-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        body:hover #ui-container {
            opacity: 1;
        }
        
        #top-ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 10px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.7) 0%, transparent 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: auto;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .image-controls {
            position: absolute;
            top: 5px;
            right: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: auto;
            z-index: 10;
        }
        
        .image-container:hover .image-controls,
        .image-controls:hover {
            opacity: 1;
        }
        
        .image-controls button {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            margin-left: 3px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .image-controls button:hover {
            background: rgba(200, 0, 0, 0.8);
            transform: scale(1.1);
        }
        
        #status {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 25px;
            border-radius: 8px;
            text-align: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            font-size: 0.9rem;
        }
        
        #status.show {
            opacity: 1;
        }
        
        /* Drag overlay for external drags */
        #drag-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 100, 255, 0.1);
            border: 3px dashed #0099ff;
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            color: white;
            pointer-events: none;
        }
        
        #drag-overlay.active {
            display: flex;
        }
    </style>
</head>
<body>
    <div id="moodboard"></div>
    <div id="drag-overlay">Drop image here</div>
    
    <div id="ui-container">
        <div id="top-ui">
            <div>Paste images (Ctrl+V) or drag images from anywhere | Drag to reorder | Ctrl+Delete to clear all</div>
        </div>
    </div>
    
    <div id="status"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const moodboard = document.getElementById('moodboard');
            const status = document.getElementById('status');
            const dragOverlay = document.getElementById('drag-overlay');
            
            let images = [];
            let draggedIndex = null;
            let dragStartX = 0;
            let dragStartY = 0;
            const DRAG_THRESHOLD = 5;
            
            // Show status message
            function showStatus(message, duration = 1500) {
                status.textContent = message;
                status.classList.add('show');
                
                setTimeout(() => {
                    status.classList.remove('show');
                }, duration);
            }
            
            // Smart grid calculation - NO BLANK SPACES
            function calculateGridLayout(count) {
                if (count === 0) return { cols: 1, rows: 1 };
                if (count === 1) return { cols: 1, rows: 1 };
                
                const screenWidth = window.innerWidth;
                const screenHeight = window.innerHeight;
                
                // Find the grid that uses all space without blank cells
                let bestCols = 1;
                let bestRows = 1;
                let bestAspectDiff = Infinity;
                
                // Try different column counts
                for (let cols = 1; cols <= count; cols++) {
                    const rows = Math.ceil(count / cols);
                    const usedCells = cols * rows;
                    
                    // Only consider layouts that use all or nearly all cells
                    if (usedCells >= count) {
                        const cellWidth = screenWidth / cols;
                        const cellHeight = screenHeight / rows;
                        const aspectDiff = Math.abs(cellWidth - cellHeight) / Math.min(cellWidth, cellHeight);
                        
                        // Prefer layouts with more square-like cells
                        if (aspectDiff < bestAspectDiff) {
                            bestAspectDiff = aspectDiff;
                            bestCols = cols;
                            bestRows = rows;
                        }
                    }
                }
                
                return { cols: bestCols, rows: bestRows };
            }
            
            // Handle paste event
            document.addEventListener('paste', async function(e) {
                const items = e.clipboardData.items;
                let imageFound = false;
                
                for (let item of items) {
                    if (item.type.indexOf('image') !== -1) {
                        imageFound = true;
                        const file = item.getAsFile();
                        await processImageFile(file);
                    }
                }
                
                if (!imageFound) {
                    showStatus('No image found in clipboard');
                }
            });
            
            // Enhanced drag and drop for external sources
            document.addEventListener('dragenter', function(e) {
                e.preventDefault();
                if (!e.target.closest('.image-container')) {
                    dragOverlay.classList.add('active');
                }
            });
            
            document.addEventListener('dragover', function(e) {
                e.preventDefault();
                if (!e.target.closest('.image-container')) {
                    dragOverlay.classList.add('active');
                }
            });
            
            document.addEventListener('dragleave', function(e) {
                if (!e.relatedTarget || e.relatedTarget === null) {
                    dragOverlay.classList.remove('active');
                }
            });
            
            document.addEventListener('drop', async function(e) {
                e.preventDefault();
                dragOverlay.classList.remove('active');
                
                // Handle external file drops
                if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                    const files = e.dataTransfer.files;
                    let imageFound = false;
                    
                    for (let file of files) {
                        if (file.type.indexOf('image') !== -1) {
                            imageFound = true;
                            await processImageFile(file);
                        }
                    }
                    
                    if (!imageFound) {
                        showStatus('No image files found');
                    }
                    return;
                }
                
                // Handle URL drops
                if (e.dataTransfer.types.includes('text/uri-list')) {
                    const url = e.dataTransfer.getData('text/uri-list');
                    if (url && isImageUrl(url)) {
                        await addImageFromUrl(url);
                    }
                    return;
                }
                
                // Handle HTML content with images
                if (e.dataTransfer.types.includes('text/html')) {
                    const html = e.dataTransfer.getData('text/html');
                    const imageUrls = extractImageUrlsFromHtml(html);
                    
                    if (imageUrls.length > 0) {
                        for (let url of imageUrls) {
                            await addImageFromUrl(url);
                        }
                    }
                    return;
                }
            });
            
            // Check if URL points to an image
            function isImageUrl(url) {
                return /\.(jpg|jpeg|png|webp|gif|bmp|svg)$/i.test(url) || 
                       url.startsWith('data:image/');
            }
            
            // Extract image URLs from HTML content
            function extractImageUrlsFromHtml(html) {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const images = doc.querySelectorAll('img');
                const urls = [];
                
                images.forEach(img => {
                    const src = img.src;
                    if (src && isImageUrl(src)) {
                        urls.push(src);
                    }
                });
                
                return urls;
            }
            
            // Add image from URL
            async function addImageFromUrl(url) {
                showStatus('Loading image...');
                
                try {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    
                    const imageData = await new Promise((resolve, reject) => {
                        img.onload = function() {
                            const canvas = document.createElement('canvas');
                            canvas.width = Math.min(img.width, 800);
                            canvas.height = Math.min(img.height, 800);
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            
                            let compressedData;
                            try {
                                compressedData = canvas.toDataURL('image/webp', 0.6);
                            } catch (e) {
                                compressedData = canvas.toDataURL('image/jpeg', 0.6);
                            }
                            
                            resolve(compressedData);
                        };
                        
                        img.onerror = () => reject(new Error('Failed to load image'));
                        img.src = url;
                    });
                    
                    addImageToMoodboard(imageData);
                    showStatus('Image added');
                } catch (error) {
                    showStatus('Error loading image');
                }
            }
            
            // Process image file
            async function processImageFile(file) {
                if (file.size > 1000000) {
                    showStatus('Image too large');
                    return;
                }
                
                const reader = new FileReader();
                
                return new Promise((resolve) => {
                    reader.onload = async function(e) {
                        const imageData = e.target.result;
                        
                        // Simple compression
                        const img = new Image();
                        img.onload = function() {
                            const canvas = document.createElement('canvas');
                            canvas.width = Math.min(img.width, 800);
                            canvas.height = Math.min(img.height, 800);
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            
                            let compressedData;
                            try {
                                compressedData = canvas.toDataURL('image/webp', 0.6);
                            } catch (e) {
                                compressedData = canvas.toDataURL('image/jpeg', 0.6);
                            }
                            
                            addImageToMoodboard(compressedData);
                            resolve();
                        };
                        img.src = imageData;
                    };
                    
                    reader.onerror = () => {
                        showStatus('Error loading image');
                        resolve();
                    };
                    
                    reader.readAsDataURL(file);
                });
            }
            
            // Add image to moodboard
            function addImageToMoodboard(imageData) {
                images.push(imageData);
                renderMoodboard();
                showStatus(`Image ${images.length} added`);
            }
            
            // Render moodboard - NO BLANK SPACES
            function renderMoodboard() {
                if (images.length === 0) {
                    moodboard.innerHTML = '';
                    moodboard.style.backgroundColor = '#000';
                    return;
                }
                
                moodboard.innerHTML = '';
                
                // Calculate grid that uses all space
                const layout = calculateGridLayout(images.length);
                moodboard.style.gridTemplateColumns = `repeat(${layout.cols}, 1fr)`;
                moodboard.style.gridTemplateRows = `repeat(${layout.rows}, 1fr)`;
                
                // Fill the grid completely
                for (let i = 0; i < layout.cols * layout.rows; i++) {
                    const imageContainer = document.createElement('div');
                    imageContainer.className = 'image-container';
                    
                    if (i < images.length) {
                        // Add actual image
                        const img = document.createElement('img');
                        img.src = images[i];
                        img.alt = `Image ${i + 1}`;
                        img.draggable = false;
                        
                        const imageControls = document.createElement('div');
                        imageControls.className = 'image-controls';
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.innerHTML = '×';
                        deleteBtn.title = 'Delete image';
                        deleteBtn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            images.splice(i, 1);
                            renderMoodboard();
                            showStatus('Image removed');
                        });
                        
                        // Drag functionality
                        imageContainer.setAttribute('data-index', i);
                        imageContainer.addEventListener('mousedown', startDrag);
                        
                        imageControls.appendChild(deleteBtn);
                        imageContainer.appendChild(img);
                        imageContainer.appendChild(imageControls);
                    } else {
                        // Fill remaining cells with empty background
                        imageContainer.style.backgroundColor = '#000';
                    }
                    
                    moodboard.appendChild(imageContainer);
                }
            }
            
            // Drag and drop functionality for reordering
            function startDrag(e) {
                e.preventDefault();
                const index = parseInt(e.currentTarget.getAttribute('data-index'));
                draggedIndex = index;
                dragStartX = e.clientX;
                dragStartY = e.clientY;
                
                document.addEventListener('mousemove', handleDrag);
                document.addEventListener('mouseup', stopDrag);
            }
            
            function handleDrag(e) {
                const dx = Math.abs(e.clientX - dragStartX);
                const dy = Math.abs(e.clientY - dragStartY);
                
                if (dx > DRAG_THRESHOLD || dy > DRAG_THRESHOLD) {
                    e.currentTarget.classList.add('dragging');
                }
            }
            
            function stopDrag(e) {
                document.removeEventListener('mousemove', handleDrag);
                document.removeEventListener('mouseup', stopDrag);
                
                const containers = document.querySelectorAll('.image-container');
                containers.forEach(container => container.classList.remove('dragging'));
                
                if (draggedIndex !== null) {
                    const finalX = e.clientX;
                    const finalY = e.clientY;
                    
                    if (finalX && finalY) {
                        const element = document.elementFromPoint(finalX, finalY);
                        if (element && element.closest('.image-container')) {
                            const targetContainer = element.closest('.image-container');
                            const targetIndex = parseInt(targetContainer.getAttribute('data-index'));
                            
                            if (draggedIndex !== targetIndex && targetIndex < images.length) {
                                // Reorder images
                                const movedImage = images.splice(draggedIndex, 1)[0];
                                images.splice(targetIndex, 0, movedImage);
                                renderMoodboard();
                                showStatus('Image moved');
                            }
                        }
                    }
                }
                
                draggedIndex = null;
            }
            
            // Clear all images
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'Delete') {
                    if (images.length > 0 && confirm('Clear all images?')) {
                        images = [];
                        renderMoodboard();
                        showStatus('All images cleared');
                    }
                }
            });
            
            // Recalculate grid on window resize
            window.addEventListener('resize', function() {
                if (images.length > 0) {
                    renderMoodboard();
                }
            });
            
            // Prevent default drag behavior
            document.addEventListener('dragstart', function(e) {
                e.preventDefault();
            });
            
            // Initial empty state
            renderMoodboard();
        });
    </script>
</body>
</html>