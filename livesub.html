<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üé§ Legenda ao Vivo Pro</title>
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    height: 100vh;
    background: #000;
    color: white;
    overflow: hidden;
  }
  #controls {
    width: 100%;
    padding: 10px;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    background: rgba(0,0,0,0.7);
    z-index: 10;
  }
  #controls label, #controls select, #controls input, #controls button {
    margin: 5px;
    font-size: 1em;
  }
  #output {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    align-items: center;
    text-align: center;
    padding: 20px;
    width: 100%;
  }
  .line {
    display: inline-block;
    margin: 6px 0;
    padding: 12px 20px;
    border-radius: 20px;
    max-width: 90%;
    line-height: 1.4em;
    word-wrap: break-word;
    color: white;
    background: rgba(0, 0, 0, 0.6);
    text-shadow: 
      -2px -2px 0 #000, 
      2px -2px 0 #000, 
      -2px 2px 0 #000, 
      2px 2px 0 #000;
  }
  .previous {
    opacity: 0.4;
  }
</style>
</head>
<body>
  <div id="controls">
    <button id="toggleBtn">‚ñ∂Ô∏è Iniciar</button>
    <label>Fundo:</label>
    <select id="bgColor">
      <option value="#000000">Preto</option>
      <option value="#00ff00">Verde (Chroma)</option>
    </select>
    <label>Mai√∫sculo:</label>
    <input type="checkbox" id="upperCase">
    <label>Fonte:</label>
    <select id="fontFamily">
      <option value="Arial">Arial</option>
      <option value="Verdana">Verdana</option>
      <option value="Impact">Impact</option>
      <option value="Courier New">Courier</option>
    </select>
    <label>Tamanho:</label>
    <input type="number" id="fontSize" value="2" step="0.2" min="1" max="6">em
    <label>Borda Letras:</label>
    <input type="color" id="borderColor" value="#000000">
    <label>Duas Linhas:</label>
    <input type="checkbox" id="twoLines" checked>
  </div>

  <div id="output">
    <div class="line previous"></div>
    <div class="line current">üéß Clique em Iniciar</div>
  </div>

<script>
let recognition;
let listening = false;
let previousText = "";
let currentText = "";
let lastFinal = "";
let silenceTimeout;

const toggleBtn = document.getElementById("toggleBtn");
const output = document.getElementById("output");
const prevLine = document.querySelector(".previous");
const currLine = document.querySelector(".current");
const bgColorSelect = document.getElementById("bgColor");

function applySettings() {
  const bgColor = bgColorSelect.value;
  document.body.style.background = bgColor;

  const fontFamily = document.getElementById("fontFamily").value;
  const fontSize = document.getElementById("fontSize").value;
  const borderColor = document.getElementById("borderColor").value;

  [prevLine, currLine].forEach(line => {
    line.style.fontFamily = fontFamily;
    line.style.fontSize = fontSize + "em";
    line.style.textShadow = `
      -2px -2px 0 ${borderColor},
       2px -2px 0 ${borderColor},
      -2px  2px 0 ${borderColor},
       2px  2px 0 ${borderColor}
    `;
    line.style.background = bgColor; // fundo s√≥lido igual ao fundo geral
  });
}

applySettings();

// Atualiza display
function updateDisplay() {
  const upper = document.getElementById("upperCase").checked;
  const twoLines = document.getElementById("twoLines").checked;

  currLine.textContent = upper ? currentText.toUpperCase() : currentText;
  if (twoLines) {
    prevLine.textContent = upper ? previousText.toUpperCase() : previousText;
    prevLine.style.display = "block";
  } else {
    prevLine.style.display = "none";
  }

  applySettings();
}

if ('webkitSpeechRecognition' in window) {
  recognition = new webkitSpeechRecognition();
  recognition.lang = 'pt-BR';
  recognition.continuous = true;
  recognition.interimResults = true;

  recognition.onresult = (event) => {
    let interim = "";
    for (let i = event.resultIndex; i < event.results.length; ++i) {
      const txt = event.results[i][0].transcript.trim();
      if (event.results[i].isFinal) {
        if (txt && txt !== lastFinal) {
          previousText = currentText;
          currentText = txt;
          lastFinal = txt;
          updateDisplay();
        }
      } else {
        interim = txt;
      }
    }
    if (interim) {
      currLine.textContent = interim;
    }
    resetSilenceTimer();
  };

  recognition.onerror = (e) => {
    if (["no-speech", "aborted", "audio-capture"].includes(e.error)) return;
    currLine.textContent = "‚ö†Ô∏è Erro: " + e.error;
  };

  recognition.onend = () => {
    if (listening) recognition.start(); // recome√ßa automaticamente
  };
} else {
  currLine.textContent = "‚ùå Navegador n√£o suporta SpeechRecognition.";
}

function resetSilenceTimer() {
  clearTimeout(silenceTimeout);
  silenceTimeout = setTimeout(() => {
    // ap√≥s sil√™ncio ‚Üí nova linha
    if (currentText && currentText !== lastFinal) {
      previousText = currentText;
      currentText = "";
      updateDisplay();
    }
  }, 4000); // pausa = 4s
}

toggleBtn.onclick = async () => {
  if (!listening) {
    try {
      await navigator.mediaDevices.getUserMedia({ audio: true });
      recognition.start();
      listening = true;
      toggleBtn.textContent = "‚èπÔ∏è Parar";
      currLine.textContent = "üéß Ouvindo...";
    } catch {
      currLine.textContent = "‚ö†Ô∏è Permita o uso do microfone.";
    }
  } else {
    listening = false;
    recognition.stop();
    toggleBtn.textContent = "‚ñ∂Ô∏è Iniciar";
    currLine.textContent = "‚è∏Ô∏è Parado";
  }
};

// Atualiza apar√™ncia ao mudar op√ß√µes
document.querySelectorAll("#controls input, #controls select")
  .forEach(el => el.addEventListener("input", applySettings));
</script>
</body>
</html>
