<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PC-98 Image Transformer</title>
<style>
  html, body { margin: 0; height: 100%; overflow: hidden; font-family: sans-serif; background: #222; color: #eee; }
  #container { display: flex; height: 100%; }
  #sidebar { width: 280px; background: #333; padding: 10px; box-sizing: border-box; overflow-y: auto; }
  #main { flex: 1; display: flex; align-items: center; justify-content: center; background: #111; position: relative; }
  canvas { image-rendering: pixelated; cursor: grab; }
  h2 { font-size: 16px; margin: 10px 0 5px; }
  label { display: block; margin: 5px 0 2px; }
  input[type=range], select, button { width: 100%; margin-bottom: 10px; }
  button { padding: 5px; background: #555; color: #eee; border: none; cursor: pointer; }
  button:hover { background: #666; }
</style>
</head>
<body>
<div id="container">
  <div id="sidebar">
    <h2>Color Adjustment</h2>
    <label>Saturation</label><input type="range" id="saturation" min="0" max="200" value="100">
    <label>Brightness</label><input type="range" id="brightness" min="0" max="200" value="100">
    <label>Contrast</label><input type="range" id="contrast" min="0" max="200" value="100">

    <h2>Levels</h2>
    <label>Shadows</label><input type="range" id="shadows" min="0" max="255" value="0">
    <label>Midtones</label><input type="range" id="midtones" min="0" max="255" value="128">
    <label>Highlights</label><input type="range" id="highlights" min="0" max="255" value="255">
    <label>Output Min</label><input type="range" id="outMin" min="0" max="255" value="0">
    <label>Output Max</label><input type="range" id="outMax" min="0" max="255" value="255">

    <h2>Palette</h2>
    <select id="palette">
      <option value="16">16-color</option>
      <option value="256">256-color</option>
      <option value="pc98">PC-98 classic</option>
    </select>
    <label>Color Depth (bits)</label><input type="range" id="colorDepth" min="2" max="8" value="8">

    <h2>Dithering</h2>
    <select id="dither">
      <option value="none">None</option>
      <option value="bayer">Ordered (Bayer)</option>
      <option value="floyd">Floyd-Steinberg</option>
      <option value="random">Random</option>
    </select>
    <label>Dither Intensity</label><input type="range" id="ditherIntensity" min="0" max="100" value="100">

    <h2>Outline Filter</h2>
    <label>Detail</label><input type="range" id="outlineDetail" min="1" max="10" value="1">
    <label>Thickness</label><input type="range" id="outlineThickness" min="1" max="10" value="1">

    <h2>Input Size</h2>
    <select id="inputSize">
      <option value="fitWidth">Fit Width</option>
      <option value="fitHeight">Fit Height</option>
      <option value="scale">Scale %</option>
    </select>
    <input type="range" id="scalePercent" min="10" max="200" value="100">

    <button id="downloadBtn">Download</button>
    <button id="resetBtn">Reset</button>

    <h2>Upload Image</h2>
    <input type="file" id="fileInput" accept="image/*">
  </div>
  <div id="main">
    <canvas id="canvas" width="640" height="400"></canvas>
  </div>
</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let img = new Image();
let imgDataOriginal = null;

// Drag & Drop
document.body.addEventListener('dragover', e => e.preventDefault());
document.body.addEventListener('drop', e => {
  e.preventDefault();
  if(e.dataTransfer.files.length) loadFile(e.dataTransfer.files[0]);
});

document.getElementById('fileInput').addEventListener('change', e => {
  if(e.target.files.length) loadFile(e.target.files[0]);
});

function loadFile(file) {
  const reader = new FileReader();
  reader.onload = e => {
    img.onload = () => {
      drawImage();
      imgDataOriginal = ctx.getImageData(0,0,canvas.width,canvas.height);
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

// Image transformations
function drawImage() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const scale = Math.min(640/img.width, 400/img.height);
  const w = img.width * scale;
  const h = img.height * scale;
  ctx.drawImage(img, 0,0,w,h);
  applyFilters();
}

function applyFilters() {
  if(!imgDataOriginal) return;
  const data = ctx.getImageData(0,0,canvas.width,canvas.height);
  const d = data.data;
  const sat = document.getElementById('saturation').value / 100;
  const bright = document.getElementById('brightness').value / 100;
  const contrast = document.getElementById('contrast').value / 100;

  for(let i=0;i<d.length;i+=4){
    // brightness
    d[i] *= bright;
    d[i+1] *= bright;
    d[i+2] *= bright;

    // saturation
    const gray = 0.3*d[i]+0.59*d[i+1]+0.11*d[i+2];
    d[i] = gray + (d[i]-gray)*sat;
    d[i+1] = gray + (d[i+1]-gray)*sat;
    d[i+2] = gray + (d[i+2]-gray)*sat;

    // contrast
    d[i] = ((d[i]-128)*contrast+128);
    d[i+1] = ((d[i+1]-128)*contrast+128);
    d[i+2] = ((d[i+2]-128)*contrast+128);
  }
  ctx.putImageData(data,0,0);
}

// Controls
const controls = document.querySelectorAll('input, select');
controls.forEach(c => c.addEventListener('input', applyFilters));

document.getElementById('downloadBtn').addEventListener('click', () => {
  const link = document.createElement('a');
  link.download = 'pc98_image.png';
  link.href = canvas.toDataURL();
  link.click();
});

document.getElementById('resetBtn').addEventListener('click', () => {
  document.querySelectorAll('input[type=range]').forEach(r=>r.value=r.defaultValue);
  drawImage();
});

// Zoom & Pan
let offsetX=0, offsetY=0, isDragging=false, startX, startY;
canvas.addEventListener('mousedown', e=>{isDragging=true; startX=e.offsetX; startY=e.offsetY;});
canvas.addEventListener('mouseup', ()=>{isDragging=false;});
canvas.addEventListener('mousemove', e=>{
  if(isDragging){
    const dx = e.offsetX - startX;
    const dy = e.offsetY - startY;
    offsetX += dx; offsetY += dy;
    startX = e.offsetX; startY = e.offsetY;
    drawImage();
  }
});
canvas.addEventListener('wheel', e=>{
  e.preventDefault();
  const scale = e.deltaY<0?1.1:0.9;
  canvas.width *= scale;
  canvas.height *= scale;
  drawImage();
});
</script>
</body>
</html>
