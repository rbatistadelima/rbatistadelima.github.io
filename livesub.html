<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>🎤 Legenda Ao Vivo</title>
<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  height: 100vh;
  background: #00ff00; /* Fundo verde padrão */
  color: white;
  overflow: hidden;
  display: flex;
  justify-content: center;
  align-items: center;
}
#controls {
  position: absolute;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  background: rgba(0,0,0,0.7);
  padding: 8px;
  border-radius: 15px;
  z-index: 10;
}
#controls label, #controls select, #controls input, #controls button {
  margin: 5px;
  font-size: 1em;
}
select#fontFamily option { font-size: 1.2em; }

#output {
  width: 100%;
  padding: 20px;
  display: flex;
  flex-direction: column;
  justify-content: flex-end;
  align-items: center;
  text-align: center;
  position: relative;
}
.line {
  display: block;
  margin: 4px 0;
  padding: 12px 25px;
  border-radius: 15px;
  max-width: 90%;
  line-height: 1.2em;
  word-wrap: break-word;
  color: white;
  background: rgba(0,0,0,0.8);
  text-shadow: -2px -2px 0 #000,
                2px -2px 0 #000,
               -2px 2px 0 #000,
                2px 2px 0 #000;
  transition: opacity 0.3s;
}
.previous { opacity: 0.5; }
.jrpg-mode {
  align-items: flex-start;
  justify-content: flex-end;
  padding: 10px;
}
.jrpg-mode .line {
  border-radius: 5px;
  text-align: left;
  max-width: 50%;
  background: rgba(0,0,0,0.9);
}

/* Barra de volume */
#volumeBar {
  position: absolute;
  bottom: 10px;
  width: 80%;
  height: 10px;
  background: rgba(255,255,255,0.2);
  border-radius: 5px;
  overflow: hidden;
}
#volumeLevel {
  width: 0%;
  height: 100%;
  background: limegreen;
}
</style>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Montserrat:wght@600&family=Oswald:wght@600&family=Roboto:wght@500&family=Lato&family=Raleway&family=PT+Sans&family=Nunito&family=Open+Sans&family=Ubuntu&family=Press+Start+2P&family=VT323&family=Roboto+Mono&display=swap" rel="stylesheet">
</head>
<body>
<div id="controls">
  <button id="toggleBtn">🎧 Clique para Iniciar</button>
  <label>Microfone:</label>
  <select id="micSelect"></select>
  <label>Fundo:</label>
  <select id="bgColor">
    <option value="#000000">Preto</option>
    <option value="#222222">Escuro</option>
  </select>
  <label>Fonte:</label>
  <select id="fontFamily">
    <option value="Arial">Arial</option>
    <option value="Verdana">Verdana</option>
    <option value="Impact">Impact</option>
    <option value="Times New Roman">Times New Roman</option>
    <option value="Comic Sans MS">Comic Sans MS</option>
    <option value="Roboto">Roboto</option>
    <option value="Oswald">Oswald</option>
    <option value="Montserrat">Montserrat</option>
    <option value="Bebas Neue">Bebas Neue</option>
    <option value="'Press Start 2P'">Pixel 1</option>
    <option value="VT323">Pixel 2</option>
    <option value="'Roboto Mono'">Pixel 3</option>
  </select>
  <label>Tamanho:</label>
  <input type="number" id="fontSize" value="2.5" step="0.1" min="1" max="8">em
  <label>Grossura Borda (max 4px):</label>
  <input type="number" id="borderWidth" value="2" step="1" min="1" max="4">
  <label>Todas Maiúsculas:</label>
  <input type="checkbox" id="allCaps">
  <label>Modo JRPG:</label>
  <input type="checkbox" id="jrpgMode">
</div>

<div id="output">
  <div class="line previous"></div>
  <div class="line current">🎧 Clique para Iniciar</div>
  <div id="volumeBar"><div id="volumeLevel"></div></div>
</div>

<script>
let recognition, listening=false;
let previousText="", currentText="", interimText="";
let selectedMicId=null, fadeTimers=[];
const toggleBtn=document.getElementById("toggleBtn");
const micSelect=document.getElementById("micSelect");
const prevLine=document.querySelector(".previous");
const currLine=document.querySelector(".current");
const jrpgCheckbox=document.getElementById("jrpgMode");
const allCapsCheckbox=document.getElementById("allCaps");
const outputDiv=document.getElementById("output");
const bgColorSelect=document.getElementById("bgColor");
const volumeLevel=document.getElementById("volumeLevel");

async function loadMicrophones(){
  const devices=await navigator.mediaDevices.enumerateDevices();
  micSelect.innerHTML="";
  devices.filter(d=>d.kind==="audioinput").forEach(device=>{
    const opt=document.createElement("option");
    const parts=device.label.split(" ");
    opt.innerHTML=parts.length>1?`<b>${parts[0]}</b> ${parts.slice(1).join(" ")}`:device.label;
    opt.value=device.deviceId;
    micSelect.appendChild(opt);
  });
}
navigator.mediaDevices.getUserMedia({audio:true}).then(loadMicrophones).catch(()=>{currLine.textContent="⚠️ Permita o uso do microfone";});

function applySettings(){
  const bgColor=bgColorSelect.value;
  const fontFamily=document.getElementById("fontFamily").value;
  const fontSize=document.getElementById("fontSize").value;
  let borderWidth=document.getElementById("borderWidth").value;
  if(borderWidth>4) borderWidth=4;
  [prevLine,currLine].forEach(line=>{
    line.style.fontFamily=fontFamily;
    line.style.fontSize=fontSize+"em";
    line.style.textShadow=`-${borderWidth}px -${borderWidth}px 0 #000,
                          ${borderWidth}px -${borderWidth}px 0 #000,
                         -${borderWidth}px ${borderWidth}px 0 #000,
                          ${borderWidth}px ${borderWidth}px 0 #000`;
    line.style.background=bgColor;
    line.style.opacity=1;
  });
  if(jrpgCheckbox.checked) outputDiv.classList.add("jrpg-mode");
  else outputDiv.classList.remove("jrpg-mode");
}

applySettings();

function splitLineWords(text){
  const words=text.split(" ");
  const lines=[];
  let currentLine="";
  for(let word of words){
    if((currentLine+" "+word).trim().length<=22) currentLine=(currentLine+" "+word).trim();
    else { if(currentLine) lines.push(currentLine); currentLine=word;}
  }
  if(currentLine) lines.push(currentLine);
  return lines;
}

function clearFadeTimers(){ fadeTimers.forEach(t=>clearTimeout(t)); fadeTimers=[];}

function updateDisplay(isFinal=false){
  clearFadeTimers();
  const lines=isFinal?splitLineWords(currentText):splitLineWords(interimText);
  let displayPrev=previousText;
  let displayCurr=lines.length>1?lines[lines.length-1]:lines[0];
  if(allCapsCheckbox.checked) { displayPrev=displayPrev.toUpperCase(); displayCurr=displayCurr.toUpperCase();}
  prevLine.textContent=displayPrev;
  currLine.textContent=displayCurr;
  if(isFinal){
    fadeTimers.push(setTimeout(()=>{
      prevLine.style.opacity=0;
      currLine.style.opacity=0;
      previousText=""; currentText="";
    },3000));
  }
}

if('webkitSpeechRecognition' in window){
  recognition=new webkitSpeechRecognition();
  recognition.lang='pt-BR';
  recognition.continuous=true;
  recognition.interimResults=true;

  recognition.onresult=(event)=>{
    let interim="";
    for(let i=event.resultIndex;i<event.results.length;i++){
      const txt=event.results[i][0].transcript.trim();
      if(event.results[i].isFinal){ currentText=txt; interimText=""; updateDisplay(true);}
      else interim=txt;
    }
    if(interim){ interimText=interim; updateDisplay(false);}
  };

  recognition.onerror=(e)=>{ if(["no-speech","aborted","audio-capture"].includes(e.error)) return; currLine.textContent="⚠️ Erro: "+e.error;}
  recognition.onend=()=>{if(listening) recognition.start();}
} else currLine.textContent="❌ Navegador não suporta SpeechRecognition";

async function toggleListening(){
  if(!listening){
    try{
      selectedMicId=micSelect.value;
      const stream=await navigator.mediaDevices.getUserMedia({audio:{deviceId:selectedMicId?{exact:selectedMicId}:undefined}});
      recognition.start(); listening=true;
      toggleBtn.textContent="⏹️ Parar"; currLine.textContent="🎧 Ouvindo...";
      setupVolumeMeter(stream);
    } catch{currLine.textContent="⚠️ Permita o uso do microfone";}
  } else{
    listening=false; recognition.stop(); toggleBtn.textContent="🎧 Clique para Iniciar"; currLine.textContent="⏸️ Parado";
  }
}

toggleBtn.onclick=toggleListening; currLine.onclick=toggleListening;
document.querySelectorAll("#controls input,#controls select").forEach(el=>el.addEventListener("input",applySettings));

// Volume Meter
function setupVolumeMeter(stream){
  const audioCtx=new AudioContext();
  const source=audioCtx.createMediaStreamSource(stream);
  const analyser=audioCtx.createAnalyser();
  analyser.fftSize=256;
  source.connect(analyser);
  const dataArray=new Uint8Array(analyser.frequencyBinCount);

  function draw(){
    requestAnimationFrame(draw);
    analyser.getByteFrequencyData(dataArray);
    const volume=Math.max(...dataArray)/255*100;
    volumeLevel.style.width=volume+"%";
  }
  draw();
}
</script>
</body>
</html>
