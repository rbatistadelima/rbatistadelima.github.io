<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Overlay Lamp on Trophy</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
  background: #f5f5f5;
  display: flex;
  justify-content: center;
  align-items: center;
  transform: rotate(90deg); /* rotate entire page */
  transform-origin: center center;
}
#controls {
  position: absolute;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%) rotate(-90deg); /* rotate UI back */
  display: flex;
  flex-direction: column;
  gap: 30px;
  background: rgba(255,255,255,0.95);
  padding: 30px;
  border-radius: 20px;
  align-items: center;
  font-size: 2em; /* 3x bigger UI */
}
input[type="range"] {
  width: 360px;
  height: 50px;
}
button {
  padding: 25px 40px;
  font-size: 2em;
  border-radius: 15px;
  cursor: pointer;
}
canvas {
  display: block;
  background: transparent;
  touch-action: none;
}
</style>
</head>
<body>
<canvas id="canvas"></canvas>
<div id="controls">
  <label>Size <input type="range" id="sizeSlider" min="50" max="600" value="200"></label>
  <label>Rotation <input type="range" id="rotationSlider" min="0" max="360" value="0"></label>
  <button id="saveBtn">Save PNG</button>
</div>

<script>
const canvas = new fabric.Canvas('canvas', { preserveObjectStacking: true, backgroundColor: null });
let lampObj, bgImg;
let trophyOriginalWidth, trophyOriginalHeight;

const TROPHY_URL = "https://raw.githubusercontent.com/rbatistadelima/rbatistadelima.github.io/master/trophy.png";
const LAMP_URL = "https://raw.githubusercontent.com/rbatistadelima/rbatistadelima.github.io/master/lamp.png";

// Load trophy
fabric.Image.fromURL(TROPHY_URL, function(img) {
  bgImg = img;
  trophyOriginalWidth = img.width;
  trophyOriginalHeight = img.height;

  resizeCanvas();

  img.set({
    originX: 'center',
    originY: 'center',
    left: canvas.width / 2,
    top: canvas.height / 2,
    selectable: false,
    evented: false
  });
  canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));

  // Load lamp
  fabric.Image.fromURL(LAMP_URL, function(lamp) {
    lampObj = lamp;
    lampObj.set({
      originX: 'center',
      originY: 'center',
      left: canvas.width / 2,
      top: canvas.height / 2,
      cornerColor: 'blue',
      transparentCorners: false,
      lockUniScaling: true,
      hasControls: true,
      selectable: true
    });
    lampObj.scaleToWidth(200);
    canvas.add(lampObj).setActiveObject(lampObj);
  });
});

// Resize canvas
function resizeCanvas() {
  if (!bgImg) return;

  const windowRatio = window.innerHeight / window.innerWidth; // swap width/height for rotation
  const trophyRatio = trophyOriginalWidth / trophyOriginalHeight;
  let canvasWidth, canvasHeight;

  if (windowRatio > trophyRatio) {
    canvasWidth = window.innerWidth;
    canvasHeight = canvasWidth / trophyRatio;
  } else {
    canvasHeight = window.innerHeight;
    canvasWidth = canvasHeight * trophyRatio;
  }

  canvas.setWidth(canvasWidth);
  canvas.setHeight(canvasHeight);

  canvas.upperCanvasEl.style.marginLeft = ((window.innerWidth - canvasWidth)/2) + 'px';
  canvas.upperCanvasEl.style.marginTop = ((window.innerHeight - canvasHeight)/2) + 'px';

  if (bgImg) {
    bgImg.scaleToWidth(canvasWidth);
    bgImg.set({ left: canvasWidth/2, top: canvasHeight/2 });
  }
  if (lampObj) {
    lampObj.set({ left: canvasWidth/2, top: canvasHeight/2 });
  }

  canvas.renderAll();
}

window.addEventListener('resize', resizeCanvas);

// Enable drag on lamp for touch and mouse
canvas.on('object:moving', function(e) {
  const obj = e.target;
  if (obj === lampObj) {
    // Optional: keep inside canvas bounds
    obj.left = Math.min(Math.max(obj.left, obj.width*obj.scaleX/2), canvas.width - obj.width*obj.scaleX/2);
    obj.top = Math.min(Math.max(obj.top, obj.height*obj.scaleY/2), canvas.height - obj.height*obj.scaleY/2);
  }
});

// Sliders
document.getElementById('sizeSlider').addEventListener('input', e => {
  if (lampObj) {
    lampObj.scaleToWidth(parseInt(e.target.value, 10));
    canvas.renderAll();
  }
});
document.getElementById('rotationSlider').addEventListener('input', e => {
  if (lampObj) {
    lampObj.set('angle', parseInt(e.target.value, 10));
    canvas.renderAll();
  }
});

// Save PNG at original trophy size
document.getElementById('saveBtn').onclick = function() {
  if (!bgImg || !lampObj) return;

  const tempCanvas = new fabric.StaticCanvas(null, {
    width: trophyOriginalWidth,
    height: trophyOriginalHeight,
    backgroundColor: null
  });

  const trophyClone = fabric.util.object.clone(bgImg);
  trophyClone.set({
    scaleX: 1,
    scaleY: 1,
    left: trophyOriginalWidth/2,
    top: trophyOriginalHeight/2,
    originX: 'center',
    originY: 'center'
  });
  tempCanvas.add(trophyClone);

  const scaleX = trophyOriginalWidth / canvas.width;
  const scaleY = trophyOriginalHeight / canvas.height;

  const lampClone = fabric.util.object.clone(lampObj);
  lampClone.set({
    left: lampObj.left * scaleX,
    top: lampObj.top * scaleY,
    scaleX: lampObj.scaleX * scaleX,
    scaleY: lampObj.scaleY * scaleY,
    angle: lampObj.angle
  });
  tempCanvas.add(lampClone);

  tempCanvas.renderAll();

  const dataURL = tempCanvas.toDataURL({ format: 'png', quality: 1 });
  const link = document.createElement('a');
  link.href = dataURL;
  link.download = 'trophy_result.png';
  link.click();
};
</script>
</body>
</html>
