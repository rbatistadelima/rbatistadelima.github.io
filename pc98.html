<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>PC-98 Studio (WebGL 2 + Masks)</title>
<style>
html,body{margin:0;height:100%;background:#111;color:#eee;font-family:sans-serif;}
#ui{position:fixed;left:0;top:0;width:280px;height:100%;overflow:hidden;
    background:#222;padding:10px;display:flex;flex-direction:column;gap:6px;box-shadow:2px 0 6px #000;}
#glCanvas{position:fixed;left:280px;top:0;right:0;bottom:0;background:#000;
          image-rendering:pixelated;}
label{font-size:12px;margin-top:4px;}
input[type=range]{width:100%;}
button{background:#333;color:#eee;border:none;padding:5px 8px;margin-top:4px;border-radius:4px;}
button:hover{background:#444;}
.row{display:flex;gap:4px;}
</style>
</head>
<body>
<div id="ui">
  <h3>PC-98 Studio</h3>
  <label>Upload Image</label>
  <input type="file" id="fileInput" accept="image/*">

  <label>Brush Size</label>
  <input type="range" id="brushSize" min="1" max="64" value="16">
  <label>Brush Opacity</label>
  <input type="range" id="brushOpacity" min="0" max="1" step="0.01" value="0.5">
  <div class="row">
    <button id="lightMode">Lighten</button>
    <button id="darkMode">Darken</button>
  </div>
  <div class="row">
    <button id="undoBtn">Undo</button>
    <button id="redoBtn">Redo</button>
  </div>
  <button id="clearBtn">Clear Masks</button>

  <hr>
  <label>Brightness</label>
  <input type="range" id="brightness" min="-1" max="1" step="0.01" value="0">
  <label>Contrast</label>
  <input type="range" id="contrast" min="-1" max="1" step="0.01" value="0">
  <label>Saturation</label>
  <input type="range" id="saturation" min="0" max="2" step="0.01" value="1">

  <button id="downloadBtn">Download</button>
  <button id="resetBtn">Reset</button>
</div>

<canvas id="glCanvas" width="640" height="400"></canvas>

<script>
const glCanvas=document.getElementById("glCanvas");
const gl=glCanvas.getContext("webgl2");
if(!gl){alert("WebGL2 not supported");throw new Error("WebGL2 not supported");}

let img=null,baseTex=null,lightTex=null,darkTex=null;
let brushSize=16,brushOpacity=0.5,mode="light";
let undoStack=[],redoStack=[];
const maskSize={w:640,h:400};
const lightMask=document.createElement("canvas");
const darkMask=document.createElement("canvas");
lightMask.width=darkMask.width=maskSize.w;
lightMask.height=darkMask.height=maskSize.h;
const lctx=lightMask.getContext("2d");
const dctx=darkMask.getContext("2d");
function clearMasks(){lctx.clearRect(0,0,maskSize.w,maskSize.h);dctx.clearRect(0,0,maskSize.w,maskSize.h);}
clearMasks();

function pushUndo(){
  if(undoStack.length>20)undoStack.shift();
  undoStack.push({
    light:lctx.getImageData(0,0,maskSize.w,maskSize.h),
    dark:dctx.getImageData(0,0,maskSize.w,maskSize.h)
  });
  redoStack=[];
}
function restore(state){
  lctx.putImageData(state.light,0,0);
  dctx.putImageData(state.dark,0,0);
  uploadMasks();
  drawScene();
}
document.getElementById("undoBtn").onclick=()=>{
  if(!undoStack.length)return;
  redoStack.push({
    light:lctx.getImageData(0,0,maskSize.w,maskSize.h),
    dark:dctx.getImageData(0,0,maskSize.w,maskSize.h)
  });
  restore(undoStack.pop());
};
document.getElementById("redoBtn").onclick=()=>{
  if(!redoStack.length)return;
  undoStack.push({
    light:lctx.getImageData(0,0,maskSize.w,maskSize.h),
    dark:dctx.getImageData(0,0,maskSize.w,maskSize.h)
  });
  restore(redoStack.pop());
};

document.getElementById("brushSize").oninput=e=>brushSize=+e.target.value;
document.getElementById("brushOpacity").oninput=e=>brushOpacity=+e.target.value;
document.getElementById("lightMode").onclick=()=>mode="light";
document.getElementById("darkMode").onclick=()=>mode="dark";
document.getElementById("clearBtn").onclick=()=>{clearMasks();uploadMasks();drawScene();};

let painting=false;
glCanvas.addEventListener("mousedown",e=>{
  if(!img)return;
  pushUndo();painting=true;
  paintAt(e);
});
glCanvas.addEventListener("mousemove",e=>painting&&paintAt(e));
window.addEventListener("mouseup",()=>painting=false);

function paintAt(e){
  const rect=glCanvas.getBoundingClientRect();
  const x=(e.clientX-rect.left)*(maskSize.w/rect.width);
  const y=(e.clientY-rect.top)*(maskSize.h/rect.height);
  const ctx=(mode==="light"?lctx:dctx);
  ctx.globalAlpha=brushOpacity;
  ctx.fillStyle=mode==="light"?"white":"black";
  ctx.beginPath();ctx.arc(x,y,brushSize,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1;
  uploadMasks();
  drawScene();
}

function makeTex(image){
  const tex=gl.createTexture();
  gl.bindTexture(gl.TEXTURE_2D,tex);
  gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);
  gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);
  gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);
  gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);
  gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,image);
  return tex;
}

function uploadMasks(){
  if(!lightTex)lightTex=gl.createTexture();
  gl.bindTexture(gl.TEXTURE_2D,lightTex);
  gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,lightMask);
  if(!darkTex)darkTex=gl.createTexture();
  gl.bindTexture(gl.TEXTURE_2D,darkTex);
  gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,darkMask);
}

document.getElementById("fileInput").onchange=e=>{
  const file=e.target.files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=ev=>{
    img=new Image();
    img.onload=()=>{
      baseTex=makeTex(img);
      uploadMasks();
      drawScene();
    };
    img.src=ev.target.result;
  };
  reader.readAsDataURL(file);
};

document.getElementById("downloadBtn").onclick=()=>{
  const link=document.createElement("a");
  link.download="pc98_webgl.png";
  link.href=glCanvas.toDataURL();
  link.click();
};

document.getElementById("resetBtn").onclick=()=>{
  ["brightness","contrast"].forEach(id=>document.getElementById(id).value=0);
  document.getElementById("saturation").value=1;
  clearMasks();uploadMasks();drawScene();
};

/* ==== SHADER creation will come in Part 2 ==== */
</script>
</body>
</html>
