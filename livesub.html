<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üé§ Legenda Ao Vivo JRPG</title>
<style>
body {
  margin: 0;
  height: 100vh;
  background: #00ff00; /* chroma verde */
  color: white;
  overflow: hidden;
  font-family: "Roboto", sans-serif;
  display: flex;
  flex-direction: column;
  justify-content: flex-end;
  align-items: center;
}
#controls {
  position: absolute;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.7);
  padding: 10px;
  border-radius: 12px;
  z-index: 10;
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
}
#controls label, #controls select, #controls input, #controls button {
  margin: 5px;
  font-size: 1em;
}
#voiceBarContainer {
  position: absolute;
  top: 0;
  width: 100%;
  height: 10px;
  background: rgba(255,255,255,0.1);
}
#voiceBar {
  width: 0%;
  height: 100%;
  background: linear-gradient(to right, lime, yellow, red);
  transition: width 0.05s linear;
}

/* --- Caixa JRPG --- */
#jrpgBox {
  position: fixed;
  bottom: 5%;
  width: 80%;
  max-width: 900px;
  min-height: 120px;
  background: rgba(0,0,0,0.85);
  border: 3px solid rgba(255,255,255,0.3);
  border-radius: 18px;
  padding: 20px 25px;
  display: flex;
  align-items: center;
  justify-content: flex-start;
  color: white;
  font-size: 2em;
  line-height: 1.3em;
  text-align: left;
  text-shadow: -2px -2px 0 #000,
                2px -2px 0 #000,
               -2px 2px 0 #000,
                2px 2px 0 #000;
  box-shadow: 0 0 20px rgba(0,0,0,0.5);
}
.hidden { display: none; }
</style>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Montserrat:wght@600&family=Oswald:wght@600&family=Roboto:wght@500&family=Lato&family=Raleway&family=PT+Sans&family=Nunito&family=Open+Sans&family=Ubuntu&family=Press+Start+2P&family=VT323&family=Roboto+Mono&display=swap" rel="stylesheet">
</head>
<body>
<div id="voiceBarContainer"><div id="voiceBar"></div></div>

<div id="controls">
  <button id="toggleBtn">üéß Clique para Iniciar</button>
  <label>Microfone:</label>
  <select id="micSelect"></select>
  <label>Fonte:</label>
  <select id="fontFamily">
    <option value="Roboto">Roboto</option>
    <option value="Oswald">Oswald</option>
    <option value="Montserrat">Montserrat</option>
    <option value="Bebas Neue">Bebas Neue</option>
    <option value="Raleway">Raleway</option>
    <option value="Nunito">Nunito</option>
    <option value="Open Sans">Open Sans</option>
    <option value="Press Start 2P">Pixel 1</option>
    <option value="VT323">Pixel 2</option>
    <option value="Roboto Mono">Pixel 3</option>
  </select>
  <label>Tamanho:</label>
  <input type="number" id="fontSize" value="2" step="0.1" min="1" max="6">em
  <label>Mai√∫sculas:</label>
  <input type="checkbox" id="allCaps">
  <label>Modo JRPG:</label>
  <input type="checkbox" id="jrpgMode">
</div>

<div id="jrpgBox" class="hidden">üéß Clique para Iniciar</div>

<script>
let recognition, listening=false;
let selectedMicId=null;
const toggleBtn=document.getElementById("toggleBtn");
const micSelect=document.getElementById("micSelect");
const jrpgBox=document.getElementById("jrpgBox");
const voiceBar=document.getElementById("voiceBar");
const fontSelect=document.getElementById("fontFamily");
const fontSizeInput=document.getElementById("fontSize");
const allCapsCheckbox=document.getElementById("allCaps");
const jrpgCheckbox=document.getElementById("jrpgMode");

async function loadMicrophones(){
  const devices=await navigator.mediaDevices.enumerateDevices();
  micSelect.innerHTML="";
  devices.filter(d=>d.kind==="audioinput").forEach(device=>{
    const opt=document.createElement("option");
    const label=device.label || "Microfone";
    const parts=label.split("(");
    opt.textContent=parts[0].trim()+(parts[1]?` (${parts[1]}`:"");
    opt.value=device.deviceId;
    micSelect.appendChild(opt);
  });
}
navigator.mediaDevices.getUserMedia({audio:true}).then(loadMicrophones).catch(()=>{jrpgBox.textContent="‚ö†Ô∏è Permita o uso do microfone";});

function applySettings(){
  jrpgBox.style.fontFamily=fontSelect.value;
  jrpgBox.style.fontSize=fontSizeInput.value+"em";
}
applySettings();
document.querySelectorAll("#controls select,#controls input").forEach(el=>el.addEventListener("input",applySettings));

function updateText(text){
  if(allCapsCheckbox.checked) text=text.toUpperCase();
  jrpgBox.textContent=text;
}

if('webkitSpeechRecognition' in window){
  recognition=new webkitSpeechRecognition();
  recognition.lang='pt-BR';
  recognition.continuous=true;
  recognition.interimResults=true;

  recognition.onresult=(event)=>{
    let interim="", final="";
    for(let i=event.resultIndex;i<event.results.length;i++){
      if(event.results[i].isFinal) final+=event.results[i][0].transcript+" ";
      else interim+=event.results[i][0].transcript;
    }
    updateText(final || interim);
  };
  recognition.onerror=(e)=>{ if(e.error!=="no-speech") jrpgBox.textContent="‚ö†Ô∏è Erro: "+e.error; };
  recognition.onend=()=>{ if(listening) recognition.start(); };
} else jrpgBox.textContent="‚ùå Navegador n√£o suporta SpeechRecognition";

async function toggleListening(){
  if(!listening){
    try{
      selectedMicId=micSelect.value;
      const stream=await navigator.mediaDevices.getUserMedia({audio:{deviceId:selectedMicId?{exact:selectedMicId}:undefined}});
      recognition.start(); listening=true;
      toggleBtn.textContent="‚èπÔ∏è Parar"; jrpgBox.textContent="üéß Ouvindo...";
      setupVoiceMeter(stream);
      if(jrpgCheckbox.checked){
        jrpgBox.classList.remove("hidden");
        document.getElementById("controls").style.display="none";
      }
    } catch{
      jrpgBox.textContent="‚ö†Ô∏è Permita o uso do microfone";
    }
  } else {
    listening=false; recognition.stop();
    toggleBtn.textContent="üéß Clique para Iniciar";
    jrpgBox.textContent="‚è∏Ô∏è Parado";
    document.getElementById("controls").style.display="flex";
  }
}
toggleBtn.onclick=toggleListening;
jrpgBox.onclick=toggleListening;

function setupVoiceMeter(stream){
  const audioCtx=new AudioContext();
  const source=audioCtx.createMediaStreamSource(stream);
  const analyser=audioCtx.createAnalyser();
  analyser.fftSize=256;
  source.connect(analyser);
  const dataArray=new Uint8Array(analyser.frequencyBinCount);

  function draw(){
    requestAnimationFrame(draw);
    analyser.getByteFrequencyData(dataArray);
    const volume=Math.max(...dataArray)/255*100;
    voiceBar.style.width=volume+"%";
  }
  draw();
}
</script>
</body>
</html>
