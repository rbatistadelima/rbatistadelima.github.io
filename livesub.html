<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>🎤 Legenda Pixel Ao Vivo</title>
<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  height: 100vh;
  background: #000;
  color: white;
  overflow: hidden;
  display: flex;
  justify-content: center;
  align-items: center;
}
#controls {
  position: absolute;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  background: rgba(0,0,0,0.7);
  padding: 8px;
  border-radius: 15px;
  z-index: 10;
}
#controls label, #controls select, #controls input, #controls button {
  margin: 5px;
  font-size: 1em;
}
select#fontFamily option { font-size: 1.2em; }
#output {
  width: 100%;
  padding: 20px;
  display: flex;
  flex-direction: column;
  justify-content: flex-end;
  align-items: center;
  text-align: center;
}
.line {
  display: block;
  margin: 2px 0;
  padding: 12px 25px;
  border-radius: 15px;
  max-width: 90%;
  line-height: 1.2em;
  word-wrap: break-word;
  color: white;
  background: rgba(0,0,0,0.8);
  text-shadow: -2px -2px 0 #000,
                2px -2px 0 #000,
               -2px 2px 0 #000,
                2px 2px 0 #000;
  transition: opacity 0.5s;
}
.previous { opacity: 0.5; }
.jrpg-mode .line {
  align-self: flex-start;
  text-align: left;
  border-radius: 5px;
}
</style>
<!-- Google Fonts + Pixel -->
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Montserrat:wght@600&family=Oswald:wght@600&family=Roboto:wght@500&family=Lato&family=Raleway&family=PT+Sans&family=Nunito&family=Open+Sans&family=Ubuntu&family=Press+Start+2P&family=VT323&family=Roboto+Mono&display=swap" rel="stylesheet">
</head>
<body>
<div id="controls">
  <button id="toggleBtn">🎧 Clique para Iniciar</button>
  <label>Microfone:</label>
  <select id="micSelect"></select>
  <label>Fundo:</label>
  <select id="bgColor">
    <option value="#000000">Preto</option>
    <option value="#00ff00">Verde (Chroma)</option>
  </select>
  <label>Fonte:</label>
  <select id="fontFamily">
    <option value="Arial">Arial</option>
    <option value="Verdana">Verdana</option>
    <option value="Impact">Impact</option>
    <option value="Times New Roman">Times New Roman</option>
    <option value="Comic Sans MS">Comic Sans MS</option>
    <option value="Roboto">Roboto</option>
    <option value="Oswald">Oswald</option>
    <option value="Montserrat">Montserrat</option>
    <option value="Bebas Neue">Bebas Neue</option>
    <option value="Lato">Lato</option>
    <option value="Raleway">Raleway</option>
    <option value="PT Sans">PT Sans</option>
    <option value="Nunito">Nunito</option>
    <option value="Open Sans">Open Sans</option>
    <option value="Ubuntu">Ubuntu</option>
    <option value="'Press Start 2P'">Pixel 1</option>
    <option value="VT323">Pixel 2</option>
    <option value="'Roboto Mono'">Pixel 3</option>
  </select>
  <label>Tamanho:</label>
  <input type="number" id="fontSize" value="2.5" step="0.1" min="1" max="8">em
  <label>Grossura Borda (max 4px):</label>
  <input type="number" id="borderWidth" value="2" step="1" min="1" max="4">
  <label>Modo JRPG:</label>
  <input type="checkbox" id="jrpgMode">
</div>

<div id="output">
  <div class="line previous"></div>
  <div class="line current">🎧 Clique para Iniciar</div>
</div>

<script>
let recognition;
let listening=false;
let previousText="";
let currentText="";
let interimText="";
let selectedMicId=null;
let fadeTimers=[];

const toggleBtn=document.getElementById("toggleBtn");
const micSelect=document.getElementById("micSelect");
const prevLine=document.querySelector(".previous");
const currLine=document.querySelector(".current");
const jrpgCheckbox=document.getElementById("jrpgMode");
const outputDiv=document.getElementById("output");
const bgColorSelect=document.getElementById("bgColor");

async function loadMicrophones(){
  const devices=await navigator.mediaDevices.enumerateDevices();
  micSelect.innerHTML="";
  devices.filter(d=>d.kind==="audioinput").forEach(device=>{
    const opt=document.createElement("option");
    const parts=device.label.split(" ");
    if(parts.length>1) opt.innerHTML=`<b>${parts[0]}</b> ${parts.slice(1).join(" ")}`;
    else opt.innerHTML=device.label;
    opt.value=device.deviceId;
    micSelect.appendChild(opt);
  });
}
navigator.mediaDevices.getUserMedia({audio:true}).then(loadMicrophones).catch(()=>{currLine.textContent="⚠️ Permita o uso do microfone";});

function applySettings(){
  const bgColor=bgColorSelect.value;
  const fontFamily=document.getElementById("fontFamily").value;
  const fontSize=document.getElementById("fontSize").value;
  let borderWidth=document.getElementById("borderWidth").value;
  if(borderWidth>4) borderWidth=4;
  document.body.style.background=bgColor;
  [prevLine,currLine].forEach(line=>{
    line.style.fontFamily=fontFamily;
    line.style.fontSize=fontSize+"em";
    line.style.textShadow=`-${borderWidth}px -${borderWidth}px 0 #000,
                          ${borderWidth}px -${borderWidth}px 0 #000,
                         -${borderWidth}px ${borderWidth}px 0 #000,
                          ${borderWidth}px ${borderWidth}px 0 #000`;
    line.style.background=bgColor==="#00ff00"?"#00ff00":"rgba(0,0,0,0.8)";
    line.style.opacity=1;
  });
  if(jrpgCheckbox.checked) outputDiv.classList.add("jrpg-mode");
  else outputDiv.classList.remove("jrpg-mode");
}
applySettings();

function splitLine(txt){
  if(txt.length<=22) return [txt];
  const parts=[];
  let i=0;
  while(i<txt.length){ parts.push(txt.slice(i,i+22)); i+=22; }
  return parts;
}

function clearFadeTimers(){
  fadeTimers.forEach(t=>clearTimeout(t));
  fadeTimers=[];
}

function updateDisplay(isFinal=false){
  clearFadeTimers();
  const lines=isFinal?splitLine(currentText):splitLine(interimText);
  if(lines.length>1){
    previousText=lines.slice(0,lines.length-1).join("\n");
    currentText=lines[lines.length-1];
  }
  // Se a linha anterior fizer parte da mesma frase, mantém opacidade
  prevLine.textContent=previousText;
  currLine.textContent=currentText;
  applySettings();
  if(isFinal){
    fadeTimers.push(setTimeout(()=>{
      prevLine.style.opacity=0;
      currLine.style.opacity=0;
      previousText="";
      currentText="";
    },5000));
  }
}

if('webkitSpeechRecognition' in window){
  recognition=new webkitSpeechRecognition();
  recognition.lang='pt-BR';
  recognition.continuous=true;
  recognition.interimResults=true;

  recognition.onresult=(event)=>{
    let interim="";
    for(let i=event.resultIndex;i<event.results.length;i++){
      const txt=event.results[i][0].transcript.trim();
      if(event.results[i].isFinal){
        currentText=txt;
        interimText="";
        updateDisplay(true);
      } else interim=txt;
    }
    if(interim){ interimText=interim; updateDisplay(false);}
  };
  recognition.onerror=(e)=>{
    if(["no-speech","aborted","audio-capture"].includes(e.error)) return;
    currLine.textContent="⚠️ Erro: "+e.error;
  };
  recognition.onend=()=>{if(listening) recognition.start();}
} else currLine.textContent="❌ Navegador não suporta SpeechRecognition";

async function toggleListening(){
  if(!listening){
    try{
      selectedMicId=micSelect.value;
      await navigator.mediaDevices.getUserMedia({audio:{deviceId:selectedMicId?{exact:selectedMicId}:undefined}});
      recognition.start();
      listening=true;
      toggleBtn.textContent="⏹️ Parar";
      currLine.textContent="🎧 Ouvindo...";
    } catch{
      currLine.textContent="⚠️ Permita o uso do microfone";
    }
  } else{
    listening=false;
    recognition.stop();
    toggleBtn.textContent="🎧 Clique para Iniciar";
    currLine.textContent="⏸️ Parado";
  }
}

toggleBtn.onclick=toggleListening;
currLine.onclick=toggleListening;
document.querySelectorAll("#controls input,#controls select").forEach(el=>el.addEventListener("input",applySettings));
</script>
</body>
</html>
